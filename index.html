<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NBA Career Map | HoopsHype</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --red: #d63031;
            --text: #222;
            --text-muted: #777;
            --border: #e5e5e5;
            --bg: #fff;
            --bg-gray: #f5f5f5;
            --green: #27ae60;
            --blue: #2980b9;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Open Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        header {
            background: var(--bg);
            padding: 10px 16px;
            border-bottom: 2px solid var(--red);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            font-weight: 700;
            font-size: 16px;
            color: var(--text);
            white-space: nowrap;
        }
        
        .logo span { color: var(--red); }
        
        .search-wrap {
            flex: 1;
            max-width: 280px;
            position: relative;
        }
        
        #search {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--border);
            border-radius: 4px;
            outline: none;
        }
        
        #search:focus {
            border-color: var(--red);
        }
        
        #results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-top: none;
            max-height: 240px;
            overflow-y: auto;
            display: none;
            z-index: 999;
        }
        
        #results.show { display: block; }
        
        .result-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }
        
        .result-item:hover { background: var(--bg-gray); }
        
        main {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 50px);
            height: calc(100dvh - 50px);
        }
        
        #map {
            height: 55%;
            min-height: 280px;
            background: #eee;
            position: relative;
        }
        
        .legend {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.95);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 999;
            display: flex;
            gap: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .legend-dot.first { background: var(--green); }
        .legend-dot.mid { background: var(--red); }
        .legend-dot.last { background: var(--blue); }
        
        .panel {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
        }
        
        .welcome { text-align: center; padding: 16px 0; }
        .welcome h2 { font-size: 18px; margin-bottom: 6px; }
        .welcome p { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; }
        
        .player-section { display: none; }
        .player-section.active { display: block; }
        
        .player-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .player-span {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .stats {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
        }
        
        .stat {
            flex: 1;
            text-align: center;
            padding: 10px 4px;
            background: var(--bg-gray);
            border-radius: 4px;
        }
        
        .stat-num {
            font-size: 20px;
            font-weight: 700;
            color: var(--red);
        }
        
        .stat-lbl {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .timeline {
            position: relative;
            margin-left: 12px;
            border-left: 2px solid var(--border);
            padding-left: 20px;
        }
        
        .stop {
            position: relative;
            padding: 10px 0;
            cursor: pointer;
            transition: background 0.1s;
            margin-left: -20px;
            padding-left: 20px;
            border-radius: 4px;
        }
        
        .stop:hover, .stop.hl { background: var(--bg-gray); }
        
        .stop-num {
            position: absolute;
            left: -31px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: var(--red);
            color: #fff;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .stop:first-child .stop-num { background: var(--green); }
        .stop:last-child .stop-num { background: var(--blue); }
        
        .stop-team {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .stop-team:hover { color: var(--red); text-decoration: underline; }
        
        .stop-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .suggestions {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .chip {
            padding: 5px 10px;
            background: var(--bg-gray);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.1s;
        }
        
        .chip:hover {
            background: var(--red);
            color: #fff;
        }
        
        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-bg.show { display: flex; }
        
        .modal {
            background: #fff;
            border-radius: 8px;
            width: 100%;
            max-width: 360px;
            max-height: 75vh;
            overflow: hidden;
        }
        
        .modal-head {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-head h3 { font-size: 15px; }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
        }
        
        .modal-body {
            padding: 12px 16px;
            max-height: 55vh;
            overflow-y: auto;
        }
        
        .modal-loc {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .modal-count {
            font-size: 11px;
            color: var(--red);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .modal-row {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .modal-row:hover { background: var(--bg-gray); }
        
        .modal-yrs { color: var(--text-muted); font-size: 11px; }
        
        /* Map markers */
        .marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 700;
            font-size: 10px;
            color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: 2px solid #fff;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content { margin: 10px 12px; font-size: 13px; }
        
        .popup-team { font-weight: 600; margin-bottom: 3px; }
        .popup-loc { font-size: 12px; color: var(--text-muted); }
        .popup-yrs { font-size: 12px; color: var(--red); margin-top: 3px; }
        
        @media (min-width: 768px) {
            main {
                flex-direction: row;
                height: calc(100vh - 50px);
            }
            
            #map {
                flex: 1;
                height: 100%;
                order: 2;
            }
            
            .panel {
                width: 360px;
                border-right: 1px solid var(--border);
                order: 1;
            }
            
            .player-name { font-size: 26px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="logo">NBA <span>Career Map</span></div>
            <div class="search-wrap">
                <input type="text" id="search" placeholder="Search player...">
                <div id="results"></div>
            </div>
        </div>
    </header>
    
    <main>
        <div id="map">
            <div class="legend">
                <div class="legend-item"><div class="legend-dot first"></div> Start</div>
                <div class="legend-item"><div class="legend-dot mid"></div> Stop</div>
                <div class="legend-item"><div class="legend-dot last"></div> Latest</div>
            </div>
        </div>
        
        <div class="panel">
            <div class="welcome" id="welcome">
                <h2>NBA Career Map</h2>
                <p>Search any player to see their career journey visualized on the map.</p>
                <div class="suggestions">
                    <div class="section-title">Popular Players</div>
                    <div class="chips" id="welcomeChips"></div>
                </div>
            </div>
            
            <div class="player-section" id="playerSection">
                <div class="player-name" id="pName"></div>
                <div class="player-span" id="pSpan"></div>
                
                <div class="stats">
                    <div class="stat"><div class="stat-num" id="sTeams">-</div><div class="stat-lbl">Teams</div></div>
                    <div class="stat"><div class="stat-num" id="sCountries">-</div><div class="stat-lbl">Countries</div></div>
                    <div class="stat"><div class="stat-num" id="sYears">-</div><div class="stat-lbl">Years</div></div>
                    <div class="stat"><div class="stat-num" id="sStops">-</div><div class="stat-lbl">Stops</div></div>
                </div>
                
                <div class="section-title">Career Timeline</div>
                <div class="timeline" id="timeline"></div>
                
                <div class="suggestions">
                    <div class="section-title">Similar Players</div>
                    <div class="chips" id="similarChips"></div>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal-bg" id="modal">
        <div class="modal">
            <div class="modal-head">
                <h3 id="mTitle"></h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="modal-loc" id="mLoc"></div>
                <div class="modal-count" id="mCount"></div>
                <div id="mList"></div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const ERAS = {
            "2020s": ["Luka DonÄiÄ‡","Giannis Antetokounmpo","Nikola JokiÄ‡","Joel Embiid","Jayson Tatum","Ja Morant","Trae Young","Anthony Edwards","LaMelo Ball","Shai Gilgeous-Alexander"],
            "2010s": ["LeBron James","Stephen Curry","Kevin Durant","James Harden","Russell Westbrook","Kawhi Leonard","Anthony Davis","Kyrie Irving","Damian Lillard","Paul George"],
            "2000s": ["Kobe Bryant","Tim Duncan","Dirk Nowitzki","Dwyane Wade","Chris Paul","Carmelo Anthony","Kevin Garnett","Paul Pierce","Steve Nash","Ray Allen"],
            "1990s": ["Michael Jordan","Shaquille O'Neal","Hakeem Olajuwon","Karl Malone","John Stockton","Charles Barkley","Patrick Ewing","Scottie Pippen","Gary Payton","Reggie Miller"],
            "1980s": ["Magic Johnson","Larry Bird","Isiah Thomas","Dominique Wilkins","Clyde Drexler","Moses Malone","James Worthy","Robert Parish","Kevin McHale","Julius Erving"]
        };
        const ALL_STARS = Object.values(ERAS).flat();
        
        const COORDS = {
            "New York|New York|USA":[40.7128,-74.006],"Brooklyn|New York|USA":[40.6782,-73.9442],"Los Angeles|California|USA":[34.0522,-118.2437],"Chicago|Illinois|USA":[41.8781,-87.6298],"Houston|Texas|USA":[29.7604,-95.3698],"Phoenix|Arizona|USA":[33.4484,-112.074],"Philadelphia|Pennsylvania|USA":[39.9526,-75.1652],"San Antonio|Texas|USA":[29.4241,-98.4936],"Dallas|Texas|USA":[32.7767,-96.797],"San Francisco|California|USA":[37.7749,-122.4194],"Indianapolis|Indiana|USA":[39.7684,-86.1581],"Seattle|Washington|USA":[47.6062,-122.3321],"Denver|Colorado|USA":[39.7392,-104.9903],"Boston|Massachusetts|USA":[42.3601,-71.0589],"Detroit|Michigan|USA":[42.3314,-83.0458],"Portland|Oregon|USA":[45.5152,-122.6784],"Memphis|Tennessee|USA":[35.1495,-90.049],"Oklahoma City|Oklahoma|USA":[35.4676,-97.5164],"Milwaukee|Wisconsin|USA":[43.0389,-87.9065],"Atlanta|Georgia|USA":[33.749,-84.388],"Sacramento|California|USA":[38.5816,-121.4944],"Miami|Florida|USA":[25.7617,-80.1918],"Orlando|Florida|USA":[28.5383,-81.3792],"Minneapolis|Minnesota|USA":[44.9778,-93.265],"Cleveland|Ohio|USA":[41.4993,-81.6944],"New Orleans|Louisiana|USA":[29.9511,-90.0715],"Salt Lake City|Utah|USA":[40.7608,-111.891],"Washington|D.C.|USA":[38.9072,-77.0369],"Charlotte|North Carolina|USA":[35.2271,-80.8431],"Toronto|Ontario|Canada":[43.6532,-79.3832],"Madrid||Spain":[40.4168,-3.7038],"Barcelona||Spain":[41.3851,2.1734],"Bologna||Italy":[44.4949,11.3426],"Milano||Italy":[45.4642,9.19],"Athens||Greece":[37.9838,23.7275],"Istanbul||Turkey":[41.0082,28.9784],"Tel Aviv||Israel":[32.0853,34.7818],"Beijing||China":[39.9042,116.4074],"Shanghai||China":[31.2304,121.4737],"Melbourne|Victoria|Australia":[-37.8136,144.9631],"Sydney|New South Wales|Australia":[-33.8688,151.2093]
        };
        const FALLBACK = {"USA":[39.8,-98.6],"Canada":[56.1,-106.3],"Spain":[40.5,-3.7],"Italy":[41.9,12.6],"France":[46.2,2.2],"Germany":[51.2,10.5],"Greece":[39.1,21.8],"Turkey":[39,35.2],"Russia":[61.5,105.3],"Serbia":[44,21],"Croatia":[45,15.2],"Slovenia":[46.2,15],"Lithuania":[55.2,23.9],"Israel":[31,34.9],"China":[35.9,104.2],"Japan":[36.2,138.3],"Australia":[-25.3,133.8],"Philippines":[12.9,121.8],"Puerto Rico":[18.2,-66.6],"Argentina":[-38.4,-63.6],"Brazil":[-14.2,-51.9],"Mexico":[23.6,-102.6]};
        const FLAGS = {"USA":"ðŸ‡ºðŸ‡¸","Canada":"ðŸ‡¨ðŸ‡¦","Spain":"ðŸ‡ªðŸ‡¸","Italy":"ðŸ‡®ðŸ‡¹","France":"ðŸ‡«ðŸ‡·","Germany":"ðŸ‡©ðŸ‡ª","Greece":"ðŸ‡¬ðŸ‡·","Turkey":"ðŸ‡¹ðŸ‡·","Russia":"ðŸ‡·ðŸ‡º","Serbia":"ðŸ‡·ðŸ‡¸","Croatia":"ðŸ‡­ðŸ‡·","Slovenia":"ðŸ‡¸ðŸ‡®","Lithuania":"ðŸ‡±ðŸ‡¹","Israel":"ðŸ‡®ðŸ‡±","China":"ðŸ‡¨ðŸ‡³","Japan":"ðŸ‡¯ðŸ‡µ","South Korea":"ðŸ‡°ðŸ‡·","Philippines":"ðŸ‡µðŸ‡­","Australia":"ðŸ‡¦ðŸ‡º","Puerto Rico":"ðŸ‡µðŸ‡·","Argentina":"ðŸ‡¦ðŸ‡·","Brazil":"ðŸ‡§ðŸ‡·","Mexico":"ðŸ‡²ðŸ‡½","Dominican Republic":"ðŸ‡©ðŸ‡´","Venezuela":"ðŸ‡»ðŸ‡ª","Poland":"ðŸ‡µðŸ‡±","Ukraine":"ðŸ‡ºðŸ‡¦","Belgium":"ðŸ‡§ðŸ‡ª","Montenegro":"ðŸ‡²ðŸ‡ª","Lebanon":"ðŸ‡±ðŸ‡§","UAE":"ðŸ‡¦ðŸ‡ª","Iran":"ðŸ‡®ðŸ‡·","Nigeria":"ðŸ‡³ðŸ‡¬","Senegal":"ðŸ‡¸ðŸ‡³","Georgia":"ðŸ‡¬ðŸ‡ª"};
        
        const getFlag = c => FLAGS[c] || 'ðŸŒ';
        const getCoords = (city,state,country) => {
            if(!city) return null;
            let k = `${city}|${state||''}|${country||''}`;
            if(COORDS[k]) return COORDS[k];
            k = `${city}||${country||''}`;
            if(COORDS[k]) return COORDS[k];
            if(country && FALLBACK[country]) {
                const b = FALLBACK[country];
                const h = city.split('').reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0);
                return [b[0]+((h%100)-50)/30, b[1]+(((h>>8)%100)-50)/30];
            }
            return null;
        };
        
        let map, markersLayer, pathLayer, markers = [];
        let players = [], data = {}, teamIdx = {}, current = null;
        
        function initMap() {
            map = L.map('map', {center:[39,-98], zoom:4});
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution:'Â©OSM Â©CARTO', subdomains:'abcd', maxZoom:19
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            pathLayer = L.layerGroup().addTo(map);
        }
        
        function clearMap() {
            markersLayer.clearLayers();
            pathLayer.clearLayers();
            markers = [];
        }
        
        function draw(career) {
            clearMap();
            const pts = [];
            career.forEach((s,i) => {
                const c = getCoords(s.city,s.state,s.country);
                if(c) pts.push({coords:c, stop:s, idx:i});
            });
            if(!pts.length) return;
            
            // Path
            if(pts.length > 1) {
                L.polyline(pts.map(p=>p.coords), {
                    color:'#d63031', weight:2, opacity:0.5, dashArray:'5,5'
                }).addTo(pathLayer);
            }
            
            // Markers
            pts.forEach((p,i) => {
                const first = i===0, last = i===pts.length-1;
                let bg = '#d63031';
                if(first) bg = '#27ae60';
                else if(last) bg = '#2980b9';
                const sz = (first||last) ? 24 : 20;
                
                const icon = L.divIcon({
                    className:'marker',
                    html:`<div style="width:${sz}px;height:${sz}px;background:${bg};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3)">${i+1}</div>`,
                    iconSize:[sz,sz], iconAnchor:[sz/2,sz/2]
                });
                
                const m = L.marker(p.coords,{icon}).addTo(markersLayer);
                markers.push({m, idx:p.idx});
                
                const loc = p.stop.state ? `${p.stop.city}, ${p.stop.state}` : p.stop.city||'';
                m.bindPopup(`<div class="popup-team">${getFlag(p.stop.country)} ${p.stop.team}</div><div class="popup-loc">${loc}${p.stop.country?', '+p.stop.country:''}</div><div class="popup-yrs">${p.stop.years}</div>`,{closeButton:false,offset:[0,-5]});
                
                m.on('mouseover',()=>hlTimeline(p.idx));
                m.on('mouseout',()=>hlTimeline(-1));
            });
            
            map.fitBounds(pts.map(p=>p.coords),{padding:[40,40],maxZoom:5});
        }
        
        function hlTimeline(idx) {
            document.querySelectorAll('.stop').forEach((el,i)=>{
                el.classList.toggle('hl',i===idx);
            });
        }
        
        function hlMarker(idx) {
            markers.forEach(({m,idx:i})=>{
                const el = m.getElement();
                if(el) {
                    const inner = el.querySelector('div');
                    if(inner) inner.style.transform = i===idx ? 'scale(1.3)' : '';
                }
            });
        }
        
        async function load() {
            const pRes = await fetch('nba_players_list.csv');
            players = (await pRes.text()).trim().split('\n').slice(1).map(l=>l.split(',')[0]?.replace(/"/g,'').trim()).filter(Boolean);
            
            const cRes = await fetch('nba_players_careers_READY.json');
            (await cRes.json()).forEach(p=>{
                data[p.player] = p;
                if(p.career_history) p.career_history.forEach(s=>{
                    if(!teamIdx[s.team]) teamIdx[s.team] = {loc:s, players:[]};
                    teamIdx[s.team].players.push({name:p.player,years:s.years});
                });
            });
            
            showWelcome();
        }
        
        function showWelcome() {
            const avail = ALL_STARS.filter(p=>data[p]).sort(()=>Math.random()-0.5).slice(0,12);
            document.getElementById('welcomeChips').innerHTML = avail.map(p=>`<div class="chip" onclick="show('${p}')">${p}</div>`).join('');
        }
        
        function getSimilar(name) {
            const p = data[name];
            if(!p) return [];
            const career = p.career_history||[];
            const y1 = parseInt(career[0]?.years?.split('-')[0])||2000;
            
            let era = "2010s";
            if(y1>=2018) era="2020s";
            else if(y1>=2005) era="2010s";
            else if(y1>=1995) era="2000s";
            else if(y1>=1985) era="1990s";
            else era="1980s";
            
            const set = new Set();
            (ERAS[era]||[]).forEach(x=>{if(x!==name&&data[x])set.add(x);});
            
            const teams = new Set(career.map(c=>c.team));
            teams.forEach(t=>{
                if(teamIdx[t]) teamIdx[t].players.forEach(x=>{
                    if(x.name!==name&&data[x.name]&&ALL_STARS.includes(x.name)) set.add(x.name);
                });
            });
            
            return [...set].slice(0,8);
        }
        
        // Search
        const searchEl = document.getElementById('search');
        const resultsEl = document.getElementById('results');
        
        searchEl.addEventListener('input',function(){
            const q = this.value.toLowerCase().trim();
            if(q.length<2){resultsEl.classList.remove('show');return;}
            const m = players.filter(n=>n.toLowerCase().includes(q)).slice(0,8);
            if(!m.length){resultsEl.classList.remove('show');return;}
            resultsEl.innerHTML = m.map(n=>`<div class="result-item" data-n="${n}">${n}</div>`).join('');
            resultsEl.classList.add('show');
        });
        
        resultsEl.addEventListener('click',e=>{
            if(e.target.classList.contains('result-item')){
                searchEl.value = e.target.dataset.n;
                resultsEl.classList.remove('show');
                show(e.target.dataset.n);
            }
        });
        
        document.addEventListener('click',e=>{
            if(!searchEl.contains(e.target)&&!resultsEl.contains(e.target)) resultsEl.classList.remove('show');
        });
        
        searchEl.addEventListener('keydown',e=>{
            if(e.key==='Enter'){
                const f = resultsEl.querySelector('.result-item');
                if(f){searchEl.value=f.dataset.n;resultsEl.classList.remove('show');show(f.dataset.n);}
            }
        });
        
        function show(name) {
            const p = data[name];
            if(!p?.career_history?.length){alert('No data available.');return;}
            
            current = name;
            const career = p.career_history;
            
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('playerSection').classList.add('active');
            
            document.getElementById('pName').textContent = name;
            const y1 = career[0].years.split('-')[0];
            const y2 = career[career.length-1].years.split('-')[1];
            document.getElementById('pSpan').textContent = `${y1} â€“ ${y2}`;
            
            document.getElementById('sTeams').textContent = new Set(career.map(c=>c.team)).size;
            document.getElementById('sCountries').textContent = new Set(career.map(c=>c.country).filter(Boolean)).size||1;
            document.getElementById('sYears').textContent = Math.max(1,parseInt(y2)-parseInt(y1));
            document.getElementById('sStops').textContent = career.length;
            
            document.getElementById('timeline').innerHTML = career.map((s,i)=>{
                const loc = s.city?(s.state?`${s.city}, ${s.state}`:s.city):'';
                return `<div class="stop" data-i="${i}" onmouseenter="hlMarker(${i})" onmouseleave="hlMarker(-1)">
                    <div class="stop-num">${i+1}</div>
                    <div class="stop-team" onclick="openModal('${s.team.replace(/'/g,"\\'")}')">${getFlag(s.country)} ${s.team}</div>
                    <div class="stop-meta">${loc}${s.country?', '+s.country:''} Â· ${s.years}</div>
                </div>`;
            }).join('');
            
            document.getElementById('similarChips').innerHTML = getSimilar(name).map(x=>`<div class="chip" onclick="show('${x}')">${x}</div>`).join('');
            
            draw(career);
            
            if(window.innerWidth<768) document.querySelector('.panel').scrollTop=0;
        }
        
        function openModal(team) {
            const t = teamIdx[team];
            if(!t) return;
            
            document.getElementById('mTitle').textContent = team;
            const loc = t.loc;
            document.getElementById('mLoc').textContent = loc.city ? `${getFlag(loc.country)} ${loc.city}${loc.state?', '+loc.state:''}${loc.country?', '+loc.country:''}` : '';
            document.getElementById('mCount').textContent = `${t.players.length} players`;
            
            const sorted = [...t.players].sort((a,b)=>(parseInt(b.years.split('-')[0])||0)-(parseInt(a.years.split('-')[0])||0));
            document.getElementById('mList').innerHTML = sorted.slice(0,50).map(x=>`<div class="modal-row" onclick="closeModal();show('${x.name.replace(/'/g,"\\'")}')"><span>${x.name}</span><span class="modal-yrs">${x.years}</span></div>`).join('') + (sorted.length>50?`<div style="padding:8px;color:#777;font-size:11px">+${sorted.length-50} more</div>`:'');
            
            document.getElementById('modal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        document.getElementById('modal').addEventListener('click',e=>{
            if(e.target.id==='modal') closeModal();
        });
        
        document.addEventListener('DOMContentLoaded',()=>{initMap();load();});
    </script>
</body>
</html>
